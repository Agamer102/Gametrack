{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Library{% endblock %}</h1>
  {% for message in get_flashed_messages() %}
    <span class="flash">{{ message }}</span>
  {% endfor %}
{% endblock %}


{% block content %}
{% if user_library %}
<div class="row row-cols-1 row-cols-md-6 g-4">
  {% for entry in user_library %}
  {% if entry.removed == 0 %}
    <div class="col">
      <div class="card">
        {% if entry.steam_appid %}
        <img src="https://steamcdn-a.akamaihd.net/steam/apps/{{ entry.steam_appid }}/library_600x900_2x.jpg" class="card-img-top" alt="">
        {% else %}
        <img src="{{ entry.image }}" class="card-img-top" alt="">
        {% endif %}
        <div class="card-body">
          <h5 class="card-title">{{ entry.name }}</h5>
          <p class="card-text">Playtime: {{ entry.time//60 }}H {{ entry.time%60 }}M</p>
          {% if entry.rating %}
          <p class="card-text"></p>Rating: {{ entry.rating }}</p>
          {% endif %}
          <p class="card-text">
            <button 
            class="btn btn-secondary btn-sm" 
            data-bs-toggle="modal" 
            data-bs-target="#updateGameModal" 
            data-bs-gameid="{{ entry.game_id }}" 
            data-bs-gamename="{{ entry.name }}" 
            data-bs-gamesteamid="{{ entry.steam_appid if entry.steam_appid is not none else '' }}"
            data-bs-gamevndbid="{{ entry.vndbid if entry.vndbid is not none else '' }}"
            data-bs-gametime="{{ entry.time }}"
            data-bs-gamerating="{{ entry.rating if entry.rating is not none else '' }}">
              Update
            </button>
          </p>  
        </div>
      </div>
    </div>
  {% endif %}
  {% endfor %}
</div>

<div class="modal fade" id="updateGameModal" tabindex="-1" aria-labelledby="updateGameLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="updateGameLabel">Update</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{{ url_for('library.update') }}" id="gameUpdateForm">
          <div class="mb-3" id="gameNameDiv">
            <label for="gameName" class="col-form-label">Name:</label>
            <input type="text" class="form-control" id="gameName" name="name" disabled>
          </div>
          <div class="mb-3" id="gameSteamIDDiv">
            <label for="gameSteamID" class="col-form-label">Steam AppID:</label>
            <input type="text" class="form-control" id="gameSteamID" name="steam_appid" disabled>
          </div>
          <div class="mb-3" id="gameVndbIDDiv">
            <label for="gameVndbID" class="col-form-label">VNDB ID:</label>
            <input type="text" class="form-control" id="gameVndbID" name="vndbid" disabled>
          </div>
          <div class="mb-3">
            <label for="gameTime" class="col-form-label">Time (in minutes):</label>
            <input type="number" class="form-control" id="gameTime" name="time">
          </div>
          <div class="mb-3">
            <label for="gameRating" class="col-form-label">Rating:</label>
            <input type="number" class="form-control" id="gameRating" name="rating">
          </div>
          <input type="hidden" id="gameID" name="game_id">
        </form>
        <div class="modal-footer">
          <form method="post" action="{{ url_for('library.delete')}}">
            <button type="submit" class="btn btn-danger" style="align-self: left;">Delete</button>
            <input type="hidden" id="gameIDDel" name="game_id">
          </form>
          <button type="submit" form="gameUpdateForm" class="btn btn-primary">Update</button>
        </div>  
      </div>
    </div>
  </div>
</div>

<script>
const updateGameModal = document.getElementById('updateGameModal')
if (updateGameModal) {
  updateGameModal.addEventListener('show.bs.modal', event => {
      // Button that triggered the modal
    const button = event.relatedTarget;
      // Extract info from data-bs-* attributes
    document.getElementById('gameID').value = button.getAttribute('data-bs-gameid');
    document.getElementById('gameIDDel').value = button.getAttribute('data-bs-gameid');
    document.getElementById('gameName').value = button.getAttribute('data-bs-gamename');
    document.getElementById('gameSteamID').value = steam_appid = button.getAttribute('data-bs-gamesteamid');
    document.getElementById('gameVndbID').value = vndbid = button.getAttribute('data-bs-gamevndbid');
    document.getElementById('gameTime').value = button.getAttribute('data-bs-gametime');
    document.getElementById('gameRating').value = button.getAttribute('data-bs-gamerating');

    // remove empty fields
    document.getElementById('gameSteamIDDiv').style.display = steam_appid != '' ? '': 'none'
    document.getElementById('gameVndbIDDiv').style.display = vndbid != '' ? '': 'none'

    })
}
</script>


{% endif %}
{% endblock %}